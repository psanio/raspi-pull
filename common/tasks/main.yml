---
- name: Update and upgrade packages
  apt:
    update_cache: yes
    upgrade: dist

- name: Install Python 3
  apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - python3-smbus
      - fail2ban
      - pure-ftpd
      - samba
      - samba-common-bin
      - smbclient
      - cifs-utils
    state: present

- name: fail2ban config
  copy:
    dest: "/etc/fail2ban/jail.local"
    content: |
      # Fail2Ban local configuration file
      [Definition]
      loglevel = INFO
      logtarget = /var/log/fail2ban.log
      syslogsocket = auto
      socket = /var/run/fail2ban/fail2ban.sock
      pidfile = /var/run/fail2ban/fail2ban.pid
      dbfile = /var/lib/fail2ban/fail2ban.sqlite3
      dbpurgeage = 1d
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 1d
      findtime = 6h
      [selinux-ssh]
      enabled = false

- name: samba config
  ansible.builtin.lineinfile:
    path: /etc/samba/smb.conf
    regexp: '^ *workgroup'
    line:    workgroup = {{workgroup}}

- name: samba config 2
  ansible.builtin.lineinfile:
    path: /etc/samba/smb.conf
    insertafter: '^* workgroup'
    line: 'client min protocol = SMB2'
    state: present
